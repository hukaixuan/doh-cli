#!/usr/bin/env python3

import dns.message
import requests
import base64
import json
import argparse
import sys

url = {
    "libredns":      "https://doh.libredns.gr/dns-query",
    "libredns-ads":  "https://doh.libredns.gr/ads",
    "google":        "https://dns.google/dns-query",
    "cloudflare":    "https://cloudflare-dns.com/dns-query",
    "quad9":         "https://dns.quad9.net/dns-query",
    "cleanbrowsing": "https://doh.cleanbrowsing.org/doh/family-filter/?ct",
    # CIRA's Canadian Shield
    # - "Private is a free DNS resolution service"
    # - "Protected adds malware and phishing blocking"
    # - "Family blocks malware and phishing plus pornographic content"
    "cira":          "https://private.canadianshield.cira.ca/dns-query",
    "cira-protect":  "https://protected.canadianshield.cira.ca/dns-query",
    "cira-family":   "https://family.canadianshield.cira.ca/dns-query",
}

parser = argparse.ArgumentParser(
    "doh-cli", description="eg. doh-cli libredns.gr A")
parser.add_argument(
    "--debug", help="show the entire response", action="store_true")
parser.add_argument(
    "--output", help="Display DNS response in plain|json format",
    choices=["plain", "json"], default="json")
parser.add_argument(
    "--dns",
    help="Choose DNS server: %s or provide your own url"%(','.join(url.keys()) ),
    default="libredns")
parser.add_argument("domain", help="The Domain Name System to resolve")
parser.add_argument(
    "RR", help="Resourse Records: A, AAAA or CNAME",
    choices=["A", "AAAA", "CNAME"], default="A")
args = parser.parse_args()

jdns = []
message = dns.message.make_query(args.domain, args.RR)
dns_req = base64.b64encode(message.to_wire()).decode("UTF8").rstrip("=")

endpoint = url[args.dns] if args.dns in url else args.dns
try:
    r = requests.get(url[args.dns] if args.dns in url else args.dns ,
                    params= {'dns':dns_req},
                    headers={"Content-type": "application/dns-message"})
except Exception as e:
    sys.stderr.write(str(e))
    sys.exit(1)


response = dns.message.from_wire(r.content)
if args.debug:
    sys.stderr.write(response.to_text())

for answer in dns.message.from_wire(r.content).answer:
    DNS = answer.to_text().split()
    if args.output == "plain":
        print(DNS[-1])
    else:
        jdns.append(
            {"Query": DNS[0], "TTL": DNS[1], "RR": DNS[3], "Answer": DNS[4]})
        print(json.dumps(jdns))
